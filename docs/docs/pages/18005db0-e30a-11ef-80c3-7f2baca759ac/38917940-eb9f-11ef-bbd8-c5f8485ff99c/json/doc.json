[{"type":"text","level":2,"children":[{"type":"text","level":0,"text":"任务流程"}]},{"type":"text","level":0,"itemType":"check","children":[{"type":"text","level":0,"text":"通过"},{"type":"text","level":0,"text":" "},{"type":"text","level":0,"text":"TextWebSocketHandler"},{"type":"text","level":0,"text":" 处理WebSocket"},{"type":"text","level":0,"text":" "},{"type":"text","level":0,"text":"消息"}]},{"type":"text","level":0,"itemType":"check","children":[{"type":"text","level":0,"text":"在"},{"type":"text","level":0,"text":" "},{"type":"text","level":0,"text":"websocket "},{"type":"text","level":0,"text":"连接时"},{"type":"text","level":0,"text":"将"},{"type":"text","level":0,"text":" "},{"type":"text","level":0,"text":"session"},{"type":"text","level":0,"text":" "},{"type":"text","level":0,"text":"中的"},{"type":"text","level":0,"text":"用户信息"},{"type":"text","level":0,"text":"查询"},{"type":"text","level":0,"text":"出来，保存到 session "},{"type":"text","level":0,"text":"中"},{"type":"text","level":0,"text":"，将session 放到"},{"type":"text","level":0,"text":"线程安全的 sessionMap"},{"type":"text","level":0,"text":" "},{"type":"text","level":0,"text":"中"}]},{"type":"text","level":0,"itemType":"check","children":[{"type":"text","level":0,"text":"在 websocket 关闭时将 session 从 sessionMap"},{"type":"text","level":0,"text":" "},{"type":"text","level":0,"text":"移除"}]},{"type":"text","level":0,"itemType":"check","children":[{"type":"text","level":0,"text":"在"},{"type":"text","level":0,"text":" "},{"type":"text","level":0,"text":"handleTextMessage"},{"type":"text","level":0,"text":" "},{"type":"text","level":0,"text":"中处理消息"},{"type":"text","level":0,"text":"，转发消息"}]},{"type":"text","level":2,"children":[{"type":"text","level":0,"text":"功能分析"}]},{"type":"text","level":0,"itemType":"li","children":[{"type":"text","level":0,"text":"转发用户消息"}]},{"type":"text","level":0,"indent":1,"itemType":"li","children":[{"type":"text","level":0,"text":"通过"},{"type":"text","level":0,"text":"userId"},{"type":"text","level":0,"text":"查询"},{"type":"text","level":0,"text":"session"},{"type":"text","level":0,"text":"，发送消息"}]},{"type":"text","level":0,"itemType":"li","children":[{"type":"text","level":0,"text":"转发群聊消息"}]},{"type":"text","level":0,"indent":1,"itemType":"li","children":[{"type":"text","level":0,"text":"从数据库"},{"type":"text","level":0,"text":"中"},{"type":"text","level":0,"text":"查询"},{"type":"text","level":0,"text":"群聊成员"},{"type":"text","level":0,"text":"("},{"type":"text","level":0,"text":"优化"},{"type":"text","level":0,"text":"性能"},{"type":"text","level":0,"text":"可加缓存"},{"type":"text","level":0,"text":"内存"},{"type":"text","level":0,"text":"表"},{"type":"text","level":0,"text":"，修改时同时修改缓存"},{"type":"text","level":0,"text":"即可"},{"type":"text","level":0,"text":")"},{"type":"text","level":0,"text":"，"},{"type":"text","level":0,"text":"对每个群聊成员"},{"type":"text","level":0,"text":"的"},{"type":"text","level":0,"text":"userId，"},{"type":"text","level":0,"text":"查询"},{"type":"text","level":0,"text":"session发送消息"}]},{"type":"text","level":2,"children":[{"type":"text","level":0,"text":"人工智能对话记录"},{"type":"text","level":0,"text":"("},{"type":"text","level":0,"text":"自然语言编程"},{"type":"text","level":0,"text":")"}]},{"type":"quote","level":0,"children":[{"type":"text","level":0,"text":"请在项目的"},{"type":"text","level":0,"text":"ChatWebSocketHandler"},{"type":"text","level":0,"text":"类中"},{"type":"text","level":0,"text":"修改逻辑，"},{"type":"text","level":0,"text":"实现"},{"type":"text","level":0,"text":"下面"},{"type":"text","level":0,"text":"2个功能："}]},{"type":"quote","level":0,"children":[{"type":"text","level":0,"text":"1.转发用户消息："},{"type":"text","level":0,"text":"通过userId查询session，发送消息"},{"type":"text","level":0,"text":"；"}]},{"type":"quote","level":0,"children":[{"type":"text","level":0,"text":"2.转发群聊消息："},{"type":"text","level":0,"text":"从数据库中查询群聊成员(优化性能可加缓存内存表，修改时同时修改缓存即可)，对每个群聊成员的userId，查询session发送消息"},{"type":"text","level":0,"text":"；"}]},{"type":"quote","level":0,"children":[{"type":"text","level":0,"text":"另外确认一下"},{"type":"text","level":0,"text":"AuthInterceptor"},{"type":"text","level":0,"text":"能否给WebSocketSession"},{"type":"text","level":0,"text":"增加用户信息，如果不能的化，"},{"type":"text","level":0,"text":"参考AuthInterceptor实现，"},{"type":"text","level":0,"text":"在请求头中获取token，然后查询用户信息，存到session。"}]},{"type":"quote","level":0,"children":[{"type":"text","level":0,"text":"另外"},{"type":"text","level":0,"text":"注意"},{"type":"text","level":0,"text":"，"},{"type":"text","level":0,"text":"text消息"},{"type":"text","level":0,"text":"通过json解析"},{"type":"text","level":0,"text":"为Message，根据这个对象得到userId或者群聊id。"}]},{"type":"quote","level":0,"children":[{"type":"text","level":0,"text":"使用MessagePO对象作为消息发送对象，在转发消息前持久化MessagePO，然后读取数据库的id到MesssagePO后转发"},{"type":"text","level":0,"text":"。"}]}]